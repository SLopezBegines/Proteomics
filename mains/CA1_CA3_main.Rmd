
# 1. Importing data

## Loading functions
```{r}
rm(list=ls())
gc()
output_path <- "./output/Thy1-CA1_CA3/"
output_path <- "./output/Thy1-CA1_CA3/CA3/"
output_path <- "./output/Thy1-CA1_CA3/CA3/Outliers_removed/"
```


```{r}
image_number <- 1
kegg_organism = "mmu"#dre for Danio rerio, hsa for Homo sapiens, mmu for Mus musculus
species <- 10090 #9606 for Human, 10090 for mouse, 7955 for zebrafish
organism <- "org.Mm.eg.db" #"org.Hs.eg.db"
```

```{r}
source("../code/global_variables.R")
source("../code/01_loading_data.R")
source("../code/03_cleaning_data.R")
source("../code/04_data_analysis.R")
```



```{r}
# Select input data file
prot_data <- readxl::read_xlsx(path = "../rawdata/Multiconsensus from 32 Reports.xlsx")
loading_data(prot_data)

```


# 2. Experiment Design
```{r}
# Experiment design ####
# You just need modify script in Experiment heading
comparisons <- c("WT_CA1_vs_NTC_CA1","L115R_CA1_vs_NTC_CA1","L116_CA1_vs_NTC_CA1","L115R_CA1_vs_WT_CA1","L116_CA1_vs_WT_CA1","L116_CA1_vs_L115R_CA1",
                 "WT_CA3_vs_NTC_CA3","L115R_CA3_vs_NTC_CA3","L116_CA3_vs_NTC_CA3","L115R_CA3_vs_WT_CA3","L116_CA3_vs_WT_CA3","L116_CA3_vs_L115R_CA3",
                 "NTC_CA1_vs_NTC_CA3","WT_CA1_vs_WT_CA3","L115R_CA1_vs_L115R_CA3","L116_CA1_vs_L116_CA3")

label <-    c("NTC_1_CA1",	"NTC_2_CA1",	"NTC_3_CA1", 	"NTC_4_CA1",	
              "WT_1_CA1",	"WT_2_CA1",	"WT_3_CA1",	"WT_4_CA1",	
              "L115_1_CA1",	"L115_2_CA1",	"L115_3_CA1",	"L115_4_CA1",	
              "L116_1_CA1",	"L116_2_CA1",	"L116_3_CA1",	"L116_4_CA1", 
              "NTC_1_CA3",	"NTC_2_CA3",	"NTC_3_CA3", 	"NTC_4_CA3",	
              "WT_1_CA3",	"WT_2_CA3",	"WT_3_CA3",	"WT_4_CA3",	
              "L115_1_CA3",	"L115_2_CA3",	"L115_3_CA3",	"L115_4_CA3",	
              "L116_1_CA3",	"L116_2_CA3",	"L116_3_CA3",	"L116_4_CA3")

label_columns <- label
columns_to_rename <-   c("NTC_CA1_1",	"NTC_CA1_2",	"NTC_CA1_3", 	"NTC_CA1_4",	
              "WT_CA1_1",	"WT_CA1_2",	"WT_CA1_3",	"WT_CA1_4",	
              "L115R_CA1_1",	"L115R_CA1_2",	"L115R_CA1_3",	"L115R_CA1_4",	
              "L116_CA1_1",	"L116_CA1_2",	"L116_CA1_3",	"L116_CA1_4", 
              "NTC_CA3_1",	"NTC_CA3_2",	"NTC_CA3_3", 	"NTC_CA3_4",	
              "WT_CA3_1",	"WT_CA3_2",	"WT_CA3_3",	"WT_CA3_4",	
              "L115R_CA3_1",	"L115R_CA3_2",	"L115R_CA3_3",	"L115R_CA3_4",	
              "L116_CA3_1",	"L116_CA3_2",	"L116_CA3_3",	"L116_CA3_4")

condition <- as.factor(c("NTC_CA1","NTC_CA1","NTC_CA1","NTC_CA1",
                         "WT_CA1","WT_CA1","WT_CA1","WT_CA1",
                         "L115R_CA1","L115R_CA1","L115R_CA1","L115R_CA1",
                         "L116_CA1","L116_CA1","L116_CA1","L116_CA1",
                         "NTC_CA3","NTC_CA3","NTC_CA3","NTC_CA3",
                         "WT_CA3","WT_CA3","WT_CA3","WT_CA3",
                         "L115R_CA3","L115R_CA3","L115R_CA3","L115R_CA3",
                         "L116_CA3","L116_CA3","L116_CA3","L116_CA3"))
  

replicate <- c(1,2,3,4,
               1,2,3,4,
               1,2,3,4,
               1,2,3,4,
               1,2,3,4,
               1,2,3,4,
               1,2,3,4,
               1,2,3,4)



experiment <- c("CA1","CA1","CA1","CA1","CA1","CA1","CA1","CA1","CA1","CA1","CA1","CA1","CA1","CA1","CA1","CA1",
                "CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3")
Exp_design <- cbind.data.frame(label,condition,replicate,columns_to_rename, experiment)
Exp_design


print(Exp_design)

Exp_design %>% 
  write_xlsx(paste0(output_path,"tables/experiment_desing.xlsx"))

```

## CA3
```{r}
# Experiment design ####
# You just need modify script in Experiment heading
comparisons <- c("WT_CA3_vs_NTC_CA3","L115R_CA3_vs_NTC_CA3","L116_CA3_vs_NTC_CA3","L115R_CA3_vs_WT_CA3","L116_CA3_vs_WT_CA3","L116_CA3_vs_L115R_CA3")

label <-    c("NTC_1_CA3",	"NTC_2_CA3",	"NTC_3_CA3", 	"NTC_4_CA3",	
              "WT_1_CA3",	"WT_2_CA3",	"WT_3_CA3",	"WT_4_CA3",	
              "L115_1_CA3",	"L115_2_CA3",	"L115_3_CA3",	"L115_4_CA3",	
              "L116_1_CA3",	"L116_2_CA3",	"L116_3_CA3",	"L116_4_CA3")

label_columns <- label
columns_to_rename <-   c("NTC_CA3_1",	"NTC_CA3_2",	"NTC_CA3_3", 	"NTC_CA3_4",	
              "WT_CA3_1",	"WT_CA3_2",	"WT_CA3_3",	"WT_CA3_4",	
              "L115R_CA3_1",	"L115R_CA3_2",	"L115R_CA3_3",	"L115R_CA3_4",	
              "L116_CA3_1",	"L116_CA3_2",	"L116_CA3_3",	"L116_CA3_4")

condition <- as.factor(c("NTC_CA3","NTC_CA3","NTC_CA3","NTC_CA3",
                         "WT_CA3","WT_CA3","WT_CA3","WT_CA3",
                         "L115R_CA3","L115R_CA3","L115R_CA3","L115R_CA3",
                         "L116_CA3","L116_CA3","L116_CA3","L116_CA3"))
  

replicate <- c(1,2,3,4,
               1,2,3,4,
               1,2,3,4,
               1,2,3,4)



experiment <- c("CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3","CA3")
Exp_design <- cbind.data.frame(label,condition,replicate,columns_to_rename, experiment)
Exp_design


print(Exp_design)

Exp_design %>% 
  write_xlsx(paste0(output_path,"tables/experiment_desing.xlsx"))

```

# 3. Data Cleaning
When your biology really includes true “off” proteins in one condition (MNAR) but you still want to preserve as much within-group variance as possible, the sweet spot in our diagnostics was a mixed imputation with:

MNAR cutoff (fraction_NA) around 0.6 (i.e. only treat proteins missing in ≥60 % of one condition as left-censored)

Down-shift factor (factor_SD_impute) around 0.05 (so your replacement values sit just below the noise floor, but don’t flatten out the variance)

MAR method = knn, MNAR method = “zero”+manual shift
```{r}

source("../code/03_cleaning_data_mixed_imputation.R")
data_cleaning(prot_data, Exp_design, comparisons, output_path, fraction_NA =0.6, factor_SD_impute =0.05, mnar_var="zero")
```


# 4. Data Analysis
```{r}
# Load desired imputation file
data_analysis(mixed_splited_imputation, Exp_design, comparisons, output_path)
```


# 5. Plots
```{r}
#Change to 1 to print Barplots
print_barplots <- 0

source("../code/05_Plots.R")

```

# 6. GO
```{r}
#Use upregulated and downregulated genes independently
independent_UPDOWN <- 0
#Select type of ontology
ont <- "ALL"  # Can be "ALL", "BP", "CC", or "MF"
source("../code/06_GO.R")

```

# 7. Strings
```{r}
independent_UPDOWN <- 1
source("../code/07_Strings.R")
```


# 8. gseGO & KEGG
```{r}
#Use upregulated and downregulated genes independently
independent_UPDOWN <- 1
#Select type of ontology
ont <- "ALL"  # Can be "ALL", "BP", "CC", or "MF"
source("../code/08_gseGO.R")

source("../code/09_gseKEGG.R")

```

# 10. RBioAPI String and Panther
```{r}
source("../code/10_RBioApi_string.R") 
source("../code/11_RBioApi_panther.R")
```

# 11. Adj

```{r}
source("../code/13_GO_padj.R")

source("../code/15_gseGO_adj.R")
source("../code/13_gseKEGG_padj.R")


```

